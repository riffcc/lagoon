# Lagoon HAProxy Configuration
#
# TLS termination on port 443 with protocol detection:
#   - HTTP traffic → lagoon-web backend (8080)
#   - IRC federation traffic → lagoon IRC backend (6667)
#
# Architecture:
#   Internet → 443 → HAProxy (TLS termination)
#                       ├─ HTTP → lagoon-web (8080)
#                       └─ IRC  → lagoon IRC (6667)

global
    log /dev/log local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # TLS tuning
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    log     global
    timeout connect 5s
    timeout client  60s
    timeout server  60s

frontend lagoon_tls
    bind *:443 ssl crt /etc/haproxy/certs/lagun.co-combined.pem
    mode tcp
    option tcplog

    # Wait for first bytes after TLS termination to detect protocol.
    tcp-request inspect-delay 5s
    tcp-request content accept if WAIT_END

    # Detect HTTP methods by first bytes (hex of ASCII).
    acl is_http payload(0,3) -m bin 474554   # GET
    acl is_http payload(0,4) -m bin 504f5354 # POST
    acl is_http payload(0,3) -m bin 505554   # PUT
    acl is_http payload(0,4) -m bin 48454144 # HEAD
    acl is_http payload(0,6) -m bin 4f5054494f4e53 # OPTIONS
    acl is_http payload(0,7) -m bin 434f4e4e454354 # CONNECT
    acl is_http payload(0,5) -m bin 5041544348 # PATCH
    acl is_http payload(0,6) -m bin 44454c455445 # DELETE

    use_backend web if is_http
    default_backend irc_federation

backend web
    mode tcp
    server lagoon-web 127.0.0.1:8080

backend irc_federation
    mode tcp
    server lagoon-irc 127.0.0.1:6667

# Redirect HTTP → HTTPS
frontend http_redirect
    bind *:80
    mode http
    http-request redirect scheme https code 301
