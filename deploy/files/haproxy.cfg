# Lagoon HAProxy Configuration
#
# Simple HTTPS reverse proxy → lagoon-web (8080)
# Everything is HTTP. WebSocket upgrade handled natively.
#
# Architecture:
#   Internet → 443 (TLS) → HAProxy → lagoon-web (8080)

global
    log /dev/log local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  86400s
    timeout server  86400s
    timeout tunnel  86400s

frontend https
    bind *:443 ssl crt /etc/haproxy/certs/lagun.co-combined.pem
    default_backend lagoon

backend lagoon
    server lagoon-web 127.0.0.1:8080

# Redirect HTTP → HTTPS
frontend http_redirect
    bind *:80
    http-request redirect scheme https code 301
